<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Anonymice Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Backup styles in case external CSS fails to load */
        .admin-body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .admin-header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .chat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            padding: 30px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .empty-state {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
        }
        
        .empty-state-content {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .empty-rooms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .empty-room {
            background: rgba(248, 250, 252, 0.8);
            border: 2px dashed rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body class="admin-body">
    <div class="admin-header">
        <h1>üê≠ Admin Dashboard</h1>
        <p>Managing up to 8 concurrent chat sessions</p>
        <div class="admin-info">
            <span>Admin: Rajendran D</span>
            <span id="activeRooms">Active Rooms: 0</span>
        </div>
    </div>

    <div class="chat-grid">
        <!-- Fixed 2x4 grid of chat windows using exact chat page design -->
        <div class="admin-chat-container" id="chat-0" data-room="0">
            <div class="chat-header">
                <h2>üí¨ Room 0</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-0">Waiting...</span>
                    <span class="status-indicator" id="status-0">‚óã</span>
                </div>
            </div>
            <div class="chat-messages" id="messages-0">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-0"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-chat-container" id="chat-1" data-room="1">
            <div class="chat-header">
                <h2>üí¨ Room 1</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-1">Waiting...</span>
                    <span class="status-indicator" id="status-1">‚óã</span>
                </div>
            </div>
            <div class="chat-messages" id="messages-1">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-1"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-chat-container" id="chat-2" data-room="2">
            <div class="chat-header">
                <h2>üí¨ Room 2</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-2">Waiting...</span>
                    <span class="status-indicator" id="status-2">‚óã</span>
                </div>
            </div>
            <div class="chat-messages" id="messages-2">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-chat-container" id="chat-3" data-room="3">
            <div class="chat-header">
                <h2>üí¨ Room 3</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-3">Waiting...</span>
                    <span class="status-indicator" id="status-3">‚óã</span>
                </div>
            </div>
            <div class="chat-messages" id="messages-3">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-chat-container" id="chat-4" data-room="4">
            <div class="chat-header">
                <h2>üí¨ Room 4</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-4">Waiting...</span>
                    <span class="status-indicator" id="status-4">‚óã</span>
                </div>
            </div>
            <div class="chat-messages" id="messages-4">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-4"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-chat-container" id="chat-5" data-room="5">
            <div class="chat-header">
                <h2>üí¨ Room 5</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-5">Waiting...</span>
                    <span class="status-indicator" id="status-5">‚óã</span>
                </div>
            </div>
            <div class="chat-messages" id="messages-5">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-5"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-chat-container" id="chat-6" data-room="6">
            <div class="chat-header">
                <h2>üí¨ Room 6</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-6">Waiting...</span>
                    <span class="status-indicator" id="status-6">‚óã</span>
                </div>
            </div>
            <div class="chat-messages" id="messages-6">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-6"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-chat-container" id="chat-7" data-room="7">
            <div class="chat-header">
                <h2>üí¨ Room 7</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-7">Waiting...</span>
                    <span class="status-indicator" id="status-7">‚óã</span>
                </div>
            </div>
            <div class="chat-messages" id="messages-7">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-7"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-footer">
        <p>üí° Tip: Each chat window represents one participant. Messages are not saved.</p>
    </div>

    <script>
        // Debug CSS loading
        console.log('üîç Debugging admin page...');
        console.log('CSS link element:', document.querySelector('link[href="styles.css"]'));
        
        const socket = io();
        const chatGrid = document.querySelector('.chat-grid');
        const activeRoomsSpan = document.getElementById('activeRooms');
        const emptyState = document.getElementById('emptyState');
        
        console.log('Chat grid element:', chatGrid);
        console.log('Active rooms span:', activeRoomsSpan);
        console.log('Empty state element:', emptyState);
        console.log('Body class:', document.body.className);
        console.log('Admin header:', document.querySelector('.admin-header'));

        let activeRooms = 0;
        let chatWindows = {};

        // Initialize all 8 rooms
        for (let i = 0; i < 8; i++) {
            setupInputUI(i);
        }

        // Connect as admin
        console.log('Attempting to connect as admin...');
        socket.emit('admin-connect');

        socket.on('admin-connected', (data) => {
            console.log('Admin connected, existing rooms:', data.rooms);
            
            // Update existing rooms
            if (data.rooms && data.rooms.length > 0) {
                data.rooms.forEach(room => {
                    console.log('Updating room:', room);
                    updateRoomParticipant(room.roomId, room.participant);
                    
                    // Add existing messages to the window
                    if (room.messages && room.messages.length > 0) {
                        // Clear the default system message
                        const messagesContainer = document.getElementById(`messages-${room.roomId}`);
                        if (messagesContainer) {
                            messagesContainer.innerHTML = '';
                        }
                        
                        room.messages.forEach(message => {
                            addMessageToWindow(room.roomId, message);
                        });
                    }
                });
            }
            
            updateActiveRooms();
        });

        socket.on('new-participant', (data) => {
            console.log('New participant:', data);
            updateRoomParticipant(data.roomId, data.participant);
            updateActiveRooms();
        });

        // Listen for new messages from participants
        socket.on('new-message', (data) => {
            console.log('New message received:', data);
            addMessageToWindow(data.roomId, data.message);
        });

        // Listen for admin messages
        socket.on('admin-message-sent', (data) => {
            console.log('Admin message sent:', data);
            addMessageToWindow(data.roomId, data.message);
        });

        socket.on('admin-message', (data) => {
            const { roomId, message } = data;
            if (chatWindows[roomId]) {
                addMessageToWindow(roomId, message);
            }
        });

        socket.on('message-sent', (message) => {
            // This handles admin's own messages
            console.log('Message sent by admin:', message);
        });

        socket.on('participant-left', (data) => {
            const { roomId, participant } = data;
            if (chatWindows[roomId]) {
                removeChatWindow(roomId);
                updateActiveRooms();
            }
        });

        function updateRoomParticipant(roomId, participant) {
            console.log('Updating room participant:', roomId, participant);
            
            const participantSpan = document.getElementById(`participant-${roomId}`);
            const statusIndicator = document.getElementById(`status-${roomId}`);
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            
            if (participantSpan) {
                participantSpan.textContent = participant.name;
                participantSpan.style.color = '#48bb78';
            }
            
            if (statusIndicator) {
                statusIndicator.textContent = '‚óè';
                statusIndicator.className = 'status-indicator online';
            }
            
            if (messagesContainer) {
                // Clear "No participant yet" message
                const systemMessage = messagesContainer.querySelector('.system-message');
                if (systemMessage && systemMessage.textContent === 'No participant yet') {
                    systemMessage.remove();
                }
            }
            
            // Setup input UI for this room
            setupInputUI(roomId);
            
            // Join the room
            socket.emit('join-room', { roomId, isAdmin: true });
        }

        function removeChatWindow(roomId) {
            console.log('Resetting room:', roomId);
            
            const participantSpan = document.getElementById(`participant-${roomId}`);
            const statusIndicator = document.getElementById(`status-${roomId}`);
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            
            if (participantSpan) {
                participantSpan.textContent = 'Waiting...';
                participantSpan.style.color = '#718096';
            }
            
            if (statusIndicator) {
                statusIndicator.textContent = '‚óã';
                statusIndicator.className = 'status-indicator';
            }
            
            if (messagesContainer) {
                messagesContainer.innerHTML = '<div class="system-message">No participant yet</div>';
            }
            
            updateActiveRooms();
        }

        function addMessageToWindow(roomId, message) {
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            if (!messagesContainer) return;

            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.isAdmin ? 'admin-message' : 'participant-message'}`;
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="sender">${message.sender}</span>
                    <span class="timestamp">${message.timestamp}</span>
                </div>
                <div class="message-text">${message.text}</div>
            `;

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage(roomId) {
            const input = document.getElementById(`input-${roomId}`);
            const message = input.value.trim();
            
            if (message) {
                // Create admin message object
                const adminMessage = {
                    id: Date.now(),
                    text: message,
                    sender: 'Rajendran D',
                    timestamp: new Date().toLocaleTimeString(),
                    isAdmin: true
                };
                
                // Immediately show the message in admin interface for instant feedback
                addMessageToWindow(roomId, adminMessage);
                
                // Send to server
                socket.emit('send-message', { text: message, roomId });
                
                // Clear input and reset UI
                input.value = '';
                autoResize(input);
                

            }
        }

        function updateActiveRooms() {
            // Count rooms with active participants
            let activeCount = 0;
            for (let i = 0; i < 8; i++) {
                const participantSpan = document.getElementById(`participant-${i}`);
                if (participantSpan && participantSpan.textContent !== 'Waiting...') {
                    activeCount++;
                }
            }
            activeRooms = activeCount;
            activeRoomsSpan.textContent = `Active Rooms: ${activeRooms}`;
        }


  // Add once in admin.html
  function insertAtCursor(textarea, text) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const value = textarea.value;
    textarea.value = value.slice(0, start) + text + value.slice(end);
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
    autoResize(textarea);
  }
  function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 160) + 'px';
  }

  function setupInputUI(roomId) {
    const textarea = document.getElementById(`input-${roomId}`);

    // Handle Enter key for sending messages
    const handleKey = (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(roomId);
        autoResize(textarea);
      }
    };

    // Auto-resize textarea
    textarea.addEventListener('input', () => autoResize(textarea));
    textarea.addEventListener('keydown', handleKey);
  }

  // Call this inside createChatWindow after adding to DOM:
  // setupInputUI(roomId);



    </script>
</body>
</html> 