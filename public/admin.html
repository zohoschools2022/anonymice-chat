<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Anonymice Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Admin dashboard styles - Dark Theme */
        .admin-body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            height: 100vh;
            margin: 0;
            padding: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .admin-header {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 20px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #e2e8f0;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .admin-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #f7fafc;
        }
        
        .admin-subtitle {
            color: #a0aec0;
            font-size: 0.85rem;
        }
        
        .admin-info {
            color: #cbd5e0;
            font-size: 0.85rem;
        }
        
        /* Chat grid - 2x4 layout */
        .chat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 15px;
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 80px);
        }
        
        /* Individual chat containers - Dark Theme */
        .admin-chat-container {
            background: #2d3748;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            height: 400px;
        }
        
        .admin-chat-container:hover {
            border-color: rgba(102, 126, 234, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .admin-chat-container .chat-header {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: #f7fafc;
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-chat-container .chat-header h2 {
            margin-bottom: 6px;
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .admin-chat-container .chat-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            color: #cbd5e0;
        }
        
        .status-indicator {
            font-size: 0.9rem;
            color: #718096;
        }
        
        .status-indicator.online {
            color: #48bb78;
        }
        
        .admin-chat-container .chat-messages {
            padding: 15px;
            overflow-y: auto;
            background: #1a202c;
            height: 260px;
        }
        
        .admin-chat-container .chat-input {
            padding: 15px;
            background: #2d3748;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            height: 100px;
        }
        
        .input-wrapper {
            width: 100%;
        }
        
        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        
        .chat-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: none;
            font-family: inherit;
            box-sizing: border-box;
            background: #1a202c;
            color: #f7fafc;
        }
        
        .chat-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: #2d3748;
        }
        
        .chat-textarea::placeholder {
            color: #718096;
        }
        
        .emoji-panel {
            display: flex;
            gap: 3px;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 4px;
            justify-content: center;
            height: 25px;
            align-items: center;
        }
        
        .emoji-btn {
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 2px 3px;
            border-radius: 3px;
            transition: background-color 0.2s;
            color: #cbd5e0;
        }
        
        .emoji-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .emoji-btn:active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .cleanup-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .cleanup-btn:hover {
            background: #059669;
        }
        
        .cleanup-btn:active {
            background: #047857;
        }
        
        .system-message {
            text-align: center;
            color: #a0aec0;
            font-style: italic;
            padding: 8px;
            background: rgba(160, 174, 192, 0.1);
            border-radius: 6px;
            margin: 8px 0;
            font-size: 0.85rem;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 85%;
            font-size: 0.85rem;
        }
        
        .participant-message {
            background: #4a5568;
            color: #f7fafc;
            margin-right: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-message {
            background: #667eea;
            color: #f7fafc;
            margin-left: auto;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
            font-size: 0.75rem;
        }
        
        .sender {
            font-weight: 600;
        }
        
        .timestamp {
            opacity: 0.7;
        }
        
        .message-text {
            line-height: 1.3;
            white-space: pre-line;
        }
        
        /* Responsive design */
        @media (max-width: 1400px) {
            .chat-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .chat-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(8, 1fr);
            }
            
            .admin-header {
                padding: 10px 15px;
            }
            
            .admin-header-content {
                flex-direction: column;
                gap: 8px;
            }
            
            .admin-title {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="admin-body">
    <div class="admin-header">
        <div class="admin-header-content">
            <div class="admin-header-left">
                <span class="admin-title">üê≠ Admin Dashboard</span>
                <span class="admin-subtitle">Managing 8 concurrent chat sessions</span>
            </div>
            <div class="admin-header-right">
                <span class="admin-info">Admin: Rajendran D</span>
                <span class="admin-info" id="activeRooms">Active Rooms: 0</span>
            </div>
        </div>
    </div>

    <div class="chat-grid">
        <!-- Room 1 -->
        <div class="admin-chat-container" id="chat-1" data-room="1">
            <div class="chat-header">
                <h2>üí¨ Room 1</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-1">Waiting...</span>
                    <span class="status-indicator" id="status-1">‚óã</span>
                </div>
                <button class="cleanup-btn" id="cleanup-1" style="display: none;">üßπ Clean</button>
            </div>
            <div class="chat-messages" id="messages-1">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="emoji-panel">
                    <button class="emoji-btn" onclick="insertEmoji(1, 'üòä')">üòä</button>
                    <button class="emoji-btn" onclick="insertEmoji(1, 'üòû')">üòû</button>
                    <button class="emoji-btn" onclick="insertEmoji(1, 'üëç')">üëç</button>
                    <button class="emoji-btn" onclick="insertEmoji(1, 'üëé')">üëé</button>
                    <button class="emoji-btn" onclick="insertEmoji(1, 'üòç')">üòç</button>
                    <button class="emoji-btn" onclick="insertEmoji(1, '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="insertEmoji(1, 'üíî')">üíî</button>
                    <button class="emoji-btn" onclick="insertEmoji(1, 'üíØ')">üíØ</button>
                    <button class="emoji-btn" onclick="insertEmoji(1, 'üôè')">üôè</button>
                </div>
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-1"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room 2 -->
        <div class="admin-chat-container" id="chat-2" data-room="2">
            <div class="chat-header">
                <h2>üí¨ Room 2</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-2">Waiting...</span>
                    <span class="status-indicator" id="status-2">‚óã</span>
                </div>
                <button class="cleanup-btn" id="cleanup-2" style="display: none;">üßπ Clean</button>
            </div>
            <div class="chat-messages" id="messages-2">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="emoji-panel">
                    <button class="emoji-btn" onclick="insertEmoji(2, 'üòä')">üòä</button>
                    <button class="emoji-btn" onclick="insertEmoji(2, 'üòû')">üòû</button>
                    <button class="emoji-btn" onclick="insertEmoji(2, 'üëç')">üëç</button>
                    <button class="emoji-btn" onclick="insertEmoji(2, 'üëé')">üëé</button>
                    <button class="emoji-btn" onclick="insertEmoji(2, 'üòç')">üòç</button>
                    <button class="emoji-btn" onclick="insertEmoji(2, '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="insertEmoji(2, 'üíî')">üíî</button>
                    <button class="emoji-btn" onclick="insertEmoji(2, 'üíØ')">üíØ</button>
                    <button class="emoji-btn" onclick="insertEmoji(2, 'üôè')">üôè</button>
                </div>
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room 3 -->
        <div class="admin-chat-container" id="chat-3" data-room="3">
            <div class="chat-header">
                <h2>üí¨ Room 3</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-3">Waiting...</span>
                    <span class="status-indicator" id="status-3">‚óã</span>
                </div>
                <button class="cleanup-btn" id="cleanup-3" style="display: none;">üßπ Clean</button>
            </div>
            <div class="chat-messages" id="messages-3">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="emoji-panel">
                    <button class="emoji-btn" onclick="insertEmoji(3, 'üòä')">üòä</button>
                    <button class="emoji-btn" onclick="insertEmoji(3, 'üòû')">üòû</button>
                    <button class="emoji-btn" onclick="insertEmoji(3, 'üëç')">üëç</button>
                    <button class="emoji-btn" onclick="insertEmoji(3, 'üëé')">üëé</button>
                    <button class="emoji-btn" onclick="insertEmoji(3, 'üòç')">üòç</button>
                    <button class="emoji-btn" onclick="insertEmoji(3, '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="insertEmoji(3, 'üíî')">üíî</button>
                    <button class="emoji-btn" onclick="insertEmoji(3, 'üíØ')">üíØ</button>
                    <button class="emoji-btn" onclick="insertEmoji(3, 'üôè')">üôè</button>
                </div>
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room 4 -->
        <div class="admin-chat-container" id="chat-4" data-room="4">
            <div class="chat-header">
                <h2>üí¨ Room 4</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-4">Waiting...</span>
                    <span class="status-indicator" id="status-4">‚óã</span>
                </div>
                <button class="cleanup-btn" id="cleanup-4" style="display: none;">üßπ Clean</button>
            </div>
            <div class="chat-messages" id="messages-4">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="emoji-panel">
                    <button class="emoji-btn" onclick="insertEmoji(4, 'üòä')">üòä</button>
                    <button class="emoji-btn" onclick="insertEmoji(4, 'üòû')">üòû</button>
                    <button class="emoji-btn" onclick="insertEmoji(4, 'üëç')">üëç</button>
                    <button class="emoji-btn" onclick="insertEmoji(4, 'üëé')">üëé</button>
                    <button class="emoji-btn" onclick="insertEmoji(4, 'üòç')">üòç</button>
                    <button class="emoji-btn" onclick="insertEmoji(4, '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="insertEmoji(4, 'üíî')">üíî</button>
                    <button class="emoji-btn" onclick="insertEmoji(4, 'üíØ')">üíØ</button>
                    <button class="emoji-btn" onclick="insertEmoji(4, 'üôè')">üôè</button>
                </div>
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-4"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room 5 -->
        <div class="admin-chat-container" id="chat-5" data-room="5">
            <div class="chat-header">
                <h2>üí¨ Room 5</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-5">Waiting...</span>
                    <span class="status-indicator" id="status-5">‚óã</span>
                </div>
                <button class="cleanup-btn" id="cleanup-5" style="display: none;">üßπ Clean</button>
            </div>
            <div class="chat-messages" id="messages-5">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="emoji-panel">
                    <button class="emoji-btn" onclick="insertEmoji(5, 'üòä')">üòä</button>
                    <button class="emoji-btn" onclick="insertEmoji(5, 'üòû')">üòû</button>
                    <button class="emoji-btn" onclick="insertEmoji(5, 'üëç')">üëç</button>
                    <button class="emoji-btn" onclick="insertEmoji(5, 'üëé')">üëé</button>
                    <button class="emoji-btn" onclick="insertEmoji(5, 'üòç')">üòç</button>
                    <button class="emoji-btn" onclick="insertEmoji(5, '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="insertEmoji(5, 'üíî')">üíî</button>
                    <button class="emoji-btn" onclick="insertEmoji(5, 'üíØ')">üíØ</button>
                    <button class="emoji-btn" onclick="insertEmoji(5, 'üôè')">üôè</button>
                </div>
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-5"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room 6 -->
        <div class="admin-chat-container" id="chat-6" data-room="6">
            <div class="chat-header">
                <h2>üí¨ Room 6</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-6">Waiting...</span>
                    <span class="status-indicator" id="status-6">‚óã</span>
                </div>
                <button class="cleanup-btn" id="cleanup-6" style="display: none;">üßπ Clean</button>
            </div>
            <div class="chat-messages" id="messages-6">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="emoji-panel">
                    <button class="emoji-btn" onclick="insertEmoji(6, 'üòä')">üòä</button>
                    <button class="emoji-btn" onclick="insertEmoji(6, 'üòû')">üòû</button>
                    <button class="emoji-btn" onclick="insertEmoji(6, 'üëç')">üëç</button>
                    <button class="emoji-btn" onclick="insertEmoji(6, 'üëé')">üëé</button>
                    <button class="emoji-btn" onclick="insertEmoji(6, 'üòç')">üòç</button>
                    <button class="emoji-btn" onclick="insertEmoji(6, '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="insertEmoji(6, 'üíî')">üíî</button>
                    <button class="emoji-btn" onclick="insertEmoji(6, 'üíØ')">üíØ</button>
                    <button class="emoji-btn" onclick="insertEmoji(6, 'üôè')">üôè</button>
                </div>
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-6"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room 7 -->
        <div class="admin-chat-container" id="chat-7" data-room="7">
            <div class="chat-header">
                <h2>üí¨ Room 7</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-7">Waiting...</span>
                    <span class="status-indicator" id="status-7">‚óã</span>
                </div>
                <button class="cleanup-btn" id="cleanup-7" style="display: none;">üßπ Clean</button>
            </div>
            <div class="chat-messages" id="messages-7">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="emoji-panel">
                    <button class="emoji-btn" onclick="insertEmoji(7, 'üòä')">üòä</button>
                    <button class="emoji-btn" onclick="insertEmoji(7, 'üòû')">üòû</button>
                    <button class="emoji-btn" onclick="insertEmoji(7, 'üëç')">üëç</button>
                    <button class="emoji-btn" onclick="insertEmoji(7, 'üëé')">üëé</button>
                    <button class="emoji-btn" onclick="insertEmoji(7, 'üòç')">üòç</button>
                    <button class="emoji-btn" onclick="insertEmoji(7, '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="insertEmoji(7, 'üíî')">üíî</button>
                    <button class="emoji-btn" onclick="insertEmoji(7, 'üíØ')">üíØ</button>
                    <button class="emoji-btn" onclick="insertEmoji(7, 'üôè')">üôè</button>
                </div>
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-7"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room 8 -->
        <div class="admin-chat-container" id="chat-8" data-room="8">
            <div class="chat-header">
                <h2>üí¨ Room 8</h2>
                <div class="chat-info">
                    <span class="participant-name" id="participant-8">Waiting...</span>
                    <span class="status-indicator" id="status-8">‚óã</span>
                </div>
                <button class="cleanup-btn" id="cleanup-8" style="display: none;">üßπ Clean</button>
            </div>
            <div class="chat-messages" id="messages-8">
                <div class="system-message">No participant yet</div>
            </div>
            <div class="chat-input">
                <div class="emoji-panel">
                    <button class="emoji-btn" onclick="insertEmoji(8, 'üòä')">üòä</button>
                    <button class="emoji-btn" onclick="insertEmoji(8, 'üòû')">üòû</button>
                    <button class="emoji-btn" onclick="insertEmoji(8, 'üëç')">üëç</button>
                    <button class="emoji-btn" onclick="insertEmoji(8, 'üëé')">üëé</button>
                    <button class="emoji-btn" onclick="insertEmoji(8, 'üòç')">üòç</button>
                    <button class="emoji-btn" onclick="insertEmoji(8, '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="insertEmoji(8, 'üíî')">üíî</button>
                    <button class="emoji-btn" onclick="insertEmoji(8, 'üíØ')">üíØ</button>
                    <button class="emoji-btn" onclick="insertEmoji(8, 'üôè')">üôè</button>
                </div>
                <div class="input-wrapper">
                    <div class="input-row">
                        <div style="position: relative; flex: 1;">
                            <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for new line)" id="input-8"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio for notifications -->
    <audio id="pingSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>

    <script>
        const socket = io();
        const activeRoomsSpan = document.getElementById('activeRooms');
        const pingSound = document.getElementById('pingSound');
        let activeRooms = 0;

        // Initialize all 8 rooms (1-8)
        for (let i = 1; i <= 8; i++) {
            setupInputUI(i);
            setupCleanupButton(i);
        }

        // Connect as admin
        console.log('Connecting as admin...');
        socket.emit('admin-connect');

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function setupInputUI(roomId) {
            const textarea = document.getElementById(`input-${roomId}`);
            
            // Auto-resize textarea
            textarea.addEventListener('input', () => autoResize(textarea));
            
            // Handle Enter key for sending messages
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(roomId);
                    autoResize(textarea);
                }
            });
        }

        // Admin connection events
        socket.on('admin-connected', (data) => {
            console.log('Admin connected, received data:', data);
            console.log('Number of rooms:', data.rooms ? data.rooms.length : 0);
            
            // Join admin room to receive messages
            socket.join('admin-room');
            
            // Join all specific rooms (1-8) to receive messages
            for (let i = 1; i <= 8; i++) {
                socket.join(`room-${i}`);
            }
            
            // Show existing rooms if any
            if (data.rooms && data.rooms.length > 0) {
                console.log('Processing existing rooms:', data.rooms);
                data.rooms.forEach(room => {
                    console.log('Processing room:', room);
                    updateRoomParticipant(room.roomId, room.participant);
                    
                    // Show existing messages
                    if (room.messages && room.messages.length > 0) {
                        console.log(`Room ${room.roomId} has ${room.messages.length} messages`);
                        const messagesContainer = document.getElementById(`messages-${room.roomId}`);
                        if (messagesContainer) {
                            messagesContainer.innerHTML = '';
                            room.messages.forEach(message => {
                                addMessageToWindow(room.roomId, message);
                            });
                        }
                    }
                });
            } else {
                console.log('No existing rooms found');
            }
            
            updateActiveRooms();
        });

        // New participant joined
        socket.on('new-participant', (data) => {
            console.log('üéâ NEW PARTICIPANT EVENT RECEIVED!');
            console.log('New participant received:', data);
            console.log('Room ID:', data.roomId, 'Type:', typeof data.roomId);
            console.log('Participant:', data.participant);
            
            // Force update with alert for testing
            if (data.roomId && data.participant) {
                updateRoomParticipant(data.roomId, data.participant);
                updateRoomStatus(data.roomId, 'active');
                updateActiveRooms();
                console.log('‚úÖ Update functions called successfully');
            } else {
                console.log('‚ùå Missing roomId or participant data');
            }
        });

        // Admin message from participant
        socket.on('admin-message', (data) => {
            console.log('Admin message received:', data);
            addMessageToWindow(data.roomId, data.message);
            // Play ping sound for new messages
            playPingSound();
        });

        // Participant left room
        socket.on('participant-left', (data) => {
            console.log('Participant left:', data);
            addMessageToWindow(data.roomId, data.message);
            updateRoomStatus(data.roomId, 'left');
            playPingSound();
        });

        // Room cleaned
        socket.on('room-cleaned', (data) => {
            console.log('Room cleaned:', data);
            addMessageToWindow(data.roomId, data.message);
            updateRoomStatus(data.roomId, 'cleaned');
            
            // Clear the messages container after a brief delay to show the cleanup message
            setTimeout(() => {
                const messagesContainer = document.getElementById(`messages-${data.roomId}`);
                if (messagesContainer) {
                    messagesContainer.innerHTML = '<div class="system-message">No participant yet</div>';
                }
            }, 2000);
        });

        // New message received
        socket.on('new-message', (data) => {
            console.log('New message received:', data);
            if (data.roomId && data.message) {
                addMessageToWindow(data.roomId, data.message);
            }
        });

        // All messages
        socket.on('message', (data) => {
            console.log('Message received:', data);
            if (data.roomId && data.message) {
                addMessageToWindow(data.roomId, data.message);
            }
        });

        // Disconnect
        socket.on('disconnect', () => {
            console.log('Connection lost');
        });

        function updateRoomParticipant(roomId, participant) {
            console.log('Updating room participant:', roomId, participant);
            console.log('Looking for elements with IDs: participant-' + roomId, 'status-' + roomId, 'messages-' + roomId);
            
            const participantSpan = document.getElementById(`participant-${roomId}`);
            const statusIndicator = document.getElementById(`status-${roomId}`);
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            
            console.log('Found elements:', { participantSpan, statusIndicator, messagesContainer });
            
            if (participantSpan) {
                participantSpan.textContent = participant.name;
                participantSpan.style.color = '#48bb78';
                console.log('Updated participant span to:', participant.name);
            } else {
                console.log('Participant span not found for room:', roomId);
            }
            
            if (statusIndicator) {
                statusIndicator.textContent = '‚óè';
                statusIndicator.className = 'status-indicator online';
                console.log('Updated status indicator');
            } else {
                console.log('Status indicator not found for room:', roomId);
            }
            
            if (messagesContainer) {
                // Clear "No participant yet" message
                const systemMessage = messagesContainer.querySelector('.system-message');
                if (systemMessage && systemMessage.textContent === 'No participant yet') {
                    systemMessage.remove();
                    console.log('Removed "No participant yet" message');
                }
            } else {
                console.log('Messages container not found for room:', roomId);
            }
        }

        function addMessageToWindow(roomId, message) {
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            if (!messagesContainer) return;

            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.isAdmin ? 'admin-message' : 'participant-message'}`;
            
            // Preserve newlines in message text
            const formattedText = message.text.replace(/\n/g, '<br>');
            
            // Debug timestamp
            console.log('üìÖ Admin received timestamp:', message.timestamp, 'Type:', typeof message.timestamp);
            
            // Format timestamp to local time with error handling
            let timestamp;
            try {
                timestamp = new Date(message.timestamp).toLocaleTimeString();
            } catch (error) {
                console.log('‚ùå Timestamp error in admin:', error);
                timestamp = new Date().toLocaleTimeString(); // Fallback
            }
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="sender">${message.sender}</span>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-text">${formattedText}</div>
            `;

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage(roomId) {
            const input = document.getElementById(`input-${roomId}`);
            const message = input.value.trim();
            
            if (message) {
                // Create admin message object
                const adminMessage = {
                    id: Date.now(),
                    text: message,
                    sender: 'Rajendran D',
                    timestamp: new Date().toISOString(),
                    isAdmin: true
                };
                
                // Immediately show the message in admin interface for instant feedback
                addMessageToWindow(roomId, adminMessage);
                
                // Send to server
                socket.emit('send-message', { text: message, roomId });
                
                // Clear input and reset UI
                input.value = '';
                autoResize(input);
            }
        }

        function updateActiveRooms() {
            // Count rooms with active participants
            let activeCount = 0;
            for (let i = 1; i <= 8; i++) {
                const participantSpan = document.getElementById(`participant-${i}`);
                if (participantSpan && participantSpan.textContent !== 'Waiting...') {
                    activeCount++;
                }
            }
            activeRooms = activeCount;
            activeRoomsSpan.textContent = `Active Rooms: ${activeRooms}`;
        }

        function insertEmoji(roomId, emoji) {
            const textarea = document.getElementById(`input-${roomId}`);
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
            textarea.focus();
            autoResize(textarea);
        }

        function setupCleanupButton(roomId) {
            const cleanupBtn = document.getElementById(`cleanup-${roomId}`);
            if (cleanupBtn) {
                cleanupBtn.addEventListener('click', () => {
                    if (confirm(`Are you sure you want to clean Room ${roomId}?`)) {
                        // Copy chat transcript to clipboard before cleaning
                        copyChatTranscriptToClipboard(roomId);
                        
                        // Send cleanup request to server
                        socket.emit('cleanup-room', { roomId });
                        cleanupBtn.style.display = 'none';
                    }
                });
            }
        }

        function copyChatTranscriptToClipboard(roomId) {
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            const participantSpan = document.getElementById(`participant-${roomId}`);
            
            if (!messagesContainer) return;
            
            // Get participant name
            const participantName = participantSpan ? participantSpan.textContent : 'Unknown';
            
            // Format the transcript
            let transcript = `üìã Chat Transcript - Room ${roomId}\n`;
            transcript += `üë§ Participant: ${participantName}\n`;
            transcript += `üìÖ Date: ${new Date().toLocaleDateString()}\n`;
            transcript += `‚è∞ Time: ${new Date().toLocaleTimeString()}\n`;
            transcript += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            // Get all messages
            const messages = messagesContainer.querySelectorAll('.message');
            messages.forEach((msgElement) => {
                const senderElement = msgElement.querySelector('.sender');
                const timestampElement = msgElement.querySelector('.timestamp');
                const textElement = msgElement.querySelector('.message-text');
                
                if (senderElement && timestampElement && textElement) {
                    const sender = senderElement.textContent;
                    const timestamp = timestampElement.textContent;
                    const text = textElement.textContent;
                    
                    const senderLabel = sender === 'Rajendran D' ? 'üë®‚Äçüíº Admin' : 'üë§ User';
                    transcript += `${timestamp} ${senderLabel}: ${text}\n\n`;
                }
            });
            
            transcript += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            transcript += `üìä Total Messages: ${messages.length}\n`;
            transcript += `‚úÖ Room cleaned and ready for next participant`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(transcript).then(() => {
                console.log('üìã Chat transcript copied to clipboard');
                // Show a brief notification
                showNotification(`Chat transcript for Room ${roomId} copied to clipboard!`);
            }).catch(err => {
                console.error('‚ùå Failed to copy to clipboard:', err);
                // Fallback: show transcript in alert
                alert('Chat transcript copied to clipboard:\n\n' + transcript.substring(0, 500) + '...');
            });
        }

        function showNotification(message) {
            // Create a temporary notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // Add animation CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
                style.remove();
            }, 3000);
        }

        function updateRoomStatus(roomId, status) {
            const participantSpan = document.getElementById(`participant-${roomId}`);
            const statusIndicator = document.getElementById(`status-${roomId}`);
            const cleanupBtn = document.getElementById(`cleanup-${roomId}`);
            
            console.log(`Updating room ${roomId} status to: ${status}`);
            
            if (status === 'active') {
                if (statusIndicator) {
                    statusIndicator.textContent = '‚óè';
                    statusIndicator.className = 'status-indicator online';
                }
                if (cleanupBtn) {
                    cleanupBtn.style.display = 'none';
                }
            } else if (status === 'left') {
                if (participantSpan) {
                    participantSpan.textContent = 'Left';
                    participantSpan.style.color = '#ef4444';
                }
                if (statusIndicator) {
                    statusIndicator.textContent = '‚óã';
                    statusIndicator.className = 'status-indicator';
                }
                if (cleanupBtn) {
                    cleanupBtn.style.display = 'inline-block';
                }
            } else if (status === 'cleaned') {
                if (participantSpan) {
                    participantSpan.textContent = 'Ready';
                    participantSpan.style.color = '#10b981';
                }
                if (statusIndicator) {
                    statusIndicator.textContent = '‚óã';
                    statusIndicator.className = 'status-indicator';
                }
                if (cleanupBtn) {
                    cleanupBtn.style.display = 'none';
                }
            }
        }

        function playPingSound() {
            try {
                // Create Web Audio API context
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                
                console.log('Ping sound played');
            } catch (error) {
                console.log('Could not play ping sound:', error);
                // Fallback to audio element
                try {
                    pingSound.currentTime = 0;
                    pingSound.play();
                } catch (fallbackError) {
                    console.log('Fallback audio also failed:', fallbackError);
                }
            }
        }

        // Test function to manually update a room (for debugging)
        function testUpdateRoom(roomId, participantName) {
            console.log('üß™ Testing manual room update for room:', roomId, 'participant:', participantName);
            const participantSpan = document.getElementById(`participant-${roomId}`);
            const statusIndicator = document.getElementById(`status-${roomId}`);
            
            console.log('Found elements:', { participantSpan, statusIndicator });
            
            if (participantSpan) {
                participantSpan.textContent = participantName;
                participantSpan.style.color = '#48bb78';
                console.log('‚úÖ Manual update successful');
            } else {
                console.log('‚ùå Manual update failed - element not found');
            }
            
            if (statusIndicator) {
                statusIndicator.textContent = '‚óè';
                statusIndicator.className = 'status-indicator online';
            }
        }

        // Test the first room manually after 3 seconds
        setTimeout(() => {
            console.log('üß™ Running manual test update...');
            testUpdateRoom(1, 'TestUser');
            
            // Also test if DOM elements exist
            console.log('üß™ Testing DOM elements...');
            for (let i = 1; i <= 8; i++) {
                const participantSpan = document.getElementById(`participant-${i}`);
                const statusIndicator = document.getElementById(`status-${i}`);
                console.log(`Room ${i}:`, { participantSpan: !!participantSpan, statusIndicator: !!statusIndicator });
            }
        }, 3000);

    </script>
</body>
</html> 