<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Anonymice Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="admin-body">
    <div class="admin-header">
        <h1>🐭 Admin Dashboard</h1>
        <p>Managing up to 8 concurrent chat sessions</p>
        <div class="admin-info">
            <span>Admin: Rajendran D</span>
            <span id="activeRooms">Active Rooms: 0</span>
        </div>
    </div>

    <div class="chat-grid">
        <!-- Chat windows will be dynamically created -->
    </div>

    <div class="admin-footer">
        <p>💡 Tip: Each chat window represents one participant. Messages are not saved.</p>
    </div>

    <script>
        const socket = io();
        const chatGrid = document.querySelector('.chat-grid');
        const activeRoomsSpan = document.getElementById('activeRooms');
        
        textarea.addEventListener('focus', () => { panel.hidden = true; });
        textarea.addEventListener('keydown', () => { panel.hidden = true; });

        let activeRooms = 0;
        let chatWindows = {};

        // Connect as admin
        socket.emit('admin-connect');

        socket.on('admin-connected', (data) => {
            console.log('Admin connected, existing rooms:', data.rooms);
            updateActiveRooms();
        });

        socket.on('new-participant', (data) => {
            console.log('New participant:', data);
            createChatWindow(data.roomId, data.participant);
            updateActiveRooms();
        });

        socket.on('admin-message', (data) => {
            const { roomId, message } = data;
            if (chatWindows[roomId]) {
                addMessageToWindow(roomId, message);
            }
        });

        socket.on('participant-left', (data) => {
            const { roomId, participant } = data;
            if (chatWindows[roomId]) {
                removeChatWindow(roomId);
                updateActiveRooms();
            }
        });

        function createChatWindow(roomId, participant) {
            const chatWindow = document.createElement('div');
            chatWindow.className = 'chat-window';
            chatWindow.id = `chat-${roomId}`;
            
            chatWindow.innerHTML = `
                <div class="chat-header">
                    <h3>Room ${roomId}</h3>
                    <span class="participant-name">${participant.name}</span>
                    <span class="status-indicator online">●</span>
                </div>
                <div class="chat-messages" id="messages-${roomId}">
                    <div class="system-message">Chat started with ${participant.name}</div>
                </div>
<div class="chat-input">
  <div class="input-wrapper">
    <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Shift+Enter for new line)" id="input-${roomId}"></textarea>
    <button class="emoji-btn" id="emojiToggle-${roomId}" type="button">😊</button>
    <div class="emoji-panel" id="emojiPanel-${roomId}" hidden>
      <button type="button" class="emoji">😀</button>
      <button type="button" class="emoji">😂</button>
      <button type="button" class="emoji">❤️</button>
      <button type="button" class="emoji">👍</button>
      <button type="button" class="emoji">🙏</button>
      <button type="button" class="emoji">🔥</button>
      <button type="button" class="emoji">🎉</button>
      <button type="button" class="emoji">😮</button>
      <button type="button" class="emoji">😢</button>
    </div>
    <button class="send-btn" type="button" title="Send" onclick="sendMessage(${roomId})">➤</button>
  </div>
</div>            `;

            chatGrid.appendChild(chatWindow);
            chatWindows[roomId] = chatWindow;

            setupInputUI(roomId);

            // Join the room
// Join the room
socket.emit('join-room', { roomId, isAdmin: true });


            // Handle enter key
            const input = chatWindow.querySelector(`#input-${roomId}`);
        }

        function removeChatWindow(roomId) {
            const chatWindow = chatWindows[roomId];
            if (chatWindow) {
                chatWindow.remove();
                delete chatWindows[roomId];
            }
        }

        function addMessageToWindow(roomId, message) {
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            if (!messagesContainer) return;

            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.isAdmin ? 'admin-message' : 'participant-message'}`;
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="sender">${message.sender}</span>
                    <span class="timestamp">${message.timestamp}</span>
                </div>
                <div class="message-text">${message.text}</div>
            `;

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage(roomId) {
            const input = document.getElementById(`input-${roomId}`);
            const message = input.value.trim();
            
            if (message) {
                socket.emit('send-message', { text: message, roomId });
                input.value = '';
            }
        }

        function updateActiveRooms() {
            activeRooms = Object.keys(chatWindows).length;
            activeRoomsSpan.textContent = `Active Rooms: ${activeRooms}`;
        }


  // Add once in admin.html
  function insertAtCursor(textarea, text) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const value = textarea.value;
    textarea.value = value.slice(0, start) + text + value.slice(end);
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
    autoResize(textarea);
  }
  function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 160) + 'px';
  }

  function setupInputUI(roomId) {
    const textarea = document.getElementById(`input-${roomId}`);
  const toggle = document.getElementById(`emojiToggle-${roomId}`);
  const panel = document.getElementById(`emojiPanel-${roomId}`);
  const wrapper = textarea.closest('.input-wrapper');

    const handleKey = (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(roomId);
      }
    };
    textarea.addEventListener('focus', () => { panel.hidden = true; wrapper.classList.remove('show-emoji'); });
  textarea.addEventListener('keydown', () => { panel.hidden = true; wrapper.classList.remove('show-emoji'); });

    textarea.addEventListener('keydown', handleKey);
    textarea.addEventListener('input', () => autoResize(textarea));

    toggle.addEventListener('click', () => {
      panel.hidden = !panel.hidden;
    });
    panel.addEventListener('click', (e) => {
      if (e.target.classList.contains('emoji')) {
        insertAtCursor(textarea, e.target.textContent);
        textarea.focus();
      }
    });
    window.addEventListener('click', (e) => {
      if (!panel.contains(e.target) && e.target !== toggle) {
        panel.hidden = true;
      }
    });
  }

  // Call this inside createChatWindow after adding to DOM:
  // setupInputUI(roomId);


        // Global function for button onclick
        window.sendMessage = sendMessage;
    </script>
</body>
</html> 