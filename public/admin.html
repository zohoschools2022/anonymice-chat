<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Anonymice Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="admin-body">
    <div class="admin-header">
        <h1>🐭 Admin Dashboard</h1>
        <p>Managing up to 8 concurrent chat sessions</p>
        <div class="admin-info">
            <span>Admin: Rajendran D</span>
            <span id="activeRooms">Active Rooms: 0</span>
        </div>
    </div>

    <div class="chat-grid">
        <!-- Chat windows will be dynamically created -->
        <div class="empty-state" id="emptyState">
            <div class="empty-state-content">
                <div class="empty-icon">🐭</div>
                <h2>No Active Chats</h2>
                <p>When participants knock and join, their chat windows will appear here.</p>
                <div class="empty-rooms">
                    <div class="empty-room" data-room="0">
                        <div class="empty-room-header">Room 0</div>
                        <div class="empty-room-content">Waiting for participant...</div>
                    </div>
                    <div class="empty-room" data-room="1">
                        <div class="empty-room-header">Room 1</div>
                        <div class="empty-room-content">Waiting for participant...</div>
                    </div>
                    <div class="empty-room" data-room="2">
                        <div class="empty-room-header">Room 2</div>
                        <div class="empty-room-content">Waiting for participant...</div>
                    </div>
                    <div class="empty-room" data-room="3">
                        <div class="empty-room-header">Room 3</div>
                        <div class="empty-room-content">Waiting for participant...</div>
                    </div>
                    <div class="empty-room" data-room="4">
                        <div class="empty-room-header">Room 4</div>
                        <div class="empty-room-content">Waiting for participant...</div>
                    </div>
                    <div class="empty-room" data-room="5">
                        <div class="empty-room-header">Room 5</div>
                        <div class="empty-room-content">Waiting for participant...</div>
                    </div>
                    <div class="empty-room" data-room="6">
                        <div class="empty-room-header">Room 6</div>
                        <div class="empty-room-content">Waiting for participant...</div>
                    </div>
                    <div class="empty-room" data-room="7">
                        <div class="empty-room-header">Room 7</div>
                        <div class="empty-room-content">Waiting for participant...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-footer">
        <p>💡 Tip: Each chat window represents one participant. Messages are not saved.</p>
    </div>

    <script>
        const socket = io();
        const chatGrid = document.querySelector('.chat-grid');
        const activeRoomsSpan = document.getElementById('activeRooms');
        
        console.log('Chat grid element:', chatGrid);
        console.log('Active rooms span:', activeRoomsSpan);

        let activeRooms = 0;
        let chatWindows = {};

        // Connect as admin
        console.log('Attempting to connect as admin...');
        socket.emit('admin-connect');

        socket.on('admin-connected', (data) => {
            console.log('Admin connected, existing rooms:', data.rooms);
            
            // Create chat windows for existing rooms
            if (data.rooms && data.rooms.length > 0) {
                data.rooms.forEach(room => {
                    console.log('Creating chat window for room:', room);
                    createChatWindow(room.roomId, room.participant);
                    
                    // Add existing messages to the window
                    if (room.messages && room.messages.length > 0) {
                        // Clear the default system message
                        const messagesContainer = document.getElementById(`messages-${room.roomId}`);
                        if (messagesContainer) {
                            messagesContainer.innerHTML = '';
                        }
                        
                        room.messages.forEach(message => {
                            addMessageToWindow(room.roomId, message);
                        });
                    }
                });
            }
            
            updateActiveRooms();
        });

        socket.on('new-participant', (data) => {
            console.log('New participant:', data);
            createChatWindow(data.roomId, data.participant);
            updateActiveRooms();
        });

        socket.on('admin-message', (data) => {
            const { roomId, message } = data;
            if (chatWindows[roomId]) {
                addMessageToWindow(roomId, message);
            }
        });

        socket.on('message-sent', (message) => {
            // This handles admin's own messages
            console.log('Message sent by admin:', message);
        });

        socket.on('participant-left', (data) => {
            const { roomId, participant } = data;
            if (chatWindows[roomId]) {
                removeChatWindow(roomId);
                updateActiveRooms();
            }
        });

        function createChatWindow(roomId, participant) {
            console.log('Creating chat window for room:', roomId, 'participant:', participant);
            
            // Hide empty state when first chat window is created
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const chatWindow = document.createElement('div');
            chatWindow.className = 'chat-window';
            chatWindow.id = `chat-${roomId}`;
            
            chatWindow.innerHTML = `
                <div class="chat-header">
                    <h3>Room ${roomId}</h3>
                    <span class="participant-name">${participant.name}</span>
                    <span class="status-indicator online">●</span>
                </div>
                <div class="chat-messages" id="messages-${roomId}">
                    <div class="system-message">Chat started with ${participant.name}</div>
                </div>
<div class="chat-input">
  <div class="input-wrapper">
    <div class="emoji-panel" id="emojiPanel-${roomId}" hidden>
      <button type="button" class="emoji">😀</button>
      <button type="button" class="emoji">😂</button>
      <button type="button" class="emoji">❤️</button>
      <button type="button" class="emoji">👍</button>
      <button type="button" class="emoji">🙏</button>
      <button type="button" class="emoji">🔥</button>
      <button type="button" class="emoji">🎉</button>
      <button type="button" class="emoji">😮</button>
      <button type="button" class="emoji">😢</button>
      <button type="button" class="emoji">😊</button>
      <button type="button" class="emoji">🤔</button>
      <button type="button" class="emoji">😎</button>
      <button type="button" class="emoji">💯</button>
      <button type="button" class="emoji">😭</button>
      <button type="button" class="emoji">🤣</button>
    </div>
    <div class="input-row">
      <button class="emoji-btn" id="emojiToggle-${roomId}" type="button">😊</button>
      <div style="position: relative; flex: 1;">
        <textarea class="chat-textarea" rows="2" placeholder="Type your message... (Shift+Enter for new line)" id="input-${roomId}"></textarea>
        <button class="send-btn" type="button" title="Send" onclick="sendMessage(${roomId})">➤</button>
      </div>
    </div>
  </div>
</div>            `;

            chatGrid.appendChild(chatWindow);
            chatWindows[roomId] = chatWindow;

            setupInputUI(roomId);

            // Join the room
            socket.emit('join-room', { roomId, isAdmin: true });
        }

        function removeChatWindow(roomId) {
            const chatWindow = chatWindows[roomId];
            if (chatWindow) {
                chatWindow.remove();
                delete chatWindows[roomId];
                
                // Show empty state if no chat windows remain
                if (Object.keys(chatWindows).length === 0) {
                    const emptyState = document.getElementById('emptyState');
                    if (emptyState) {
                        emptyState.style.display = 'flex';
                    }
                }
            }
        }

        function addMessageToWindow(roomId, message) {
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            if (!messagesContainer) return;

            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.isAdmin ? 'admin-message' : 'participant-message'}`;
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="sender">${message.sender}</span>
                    <span class="timestamp">${message.timestamp}</span>
                </div>
                <div class="message-text">${message.text}</div>
            `;

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage(roomId) {
            const input = document.getElementById(`input-${roomId}`);
            const message = input.value.trim();
            
            if (message) {
                // Create admin message object
                const adminMessage = {
                    id: Date.now(),
                    text: message,
                    sender: 'Rajendran D',
                    timestamp: new Date().toLocaleTimeString(),
                    isAdmin: true
                };
                
                // Immediately show the message in admin interface
                addMessageToWindow(roomId, adminMessage);
                
                // Send to server
                socket.emit('send-message', { text: message, roomId });
                
                // Clear input and reset UI
                input.value = '';
                autoResize(input);
                
                // Hide emoji panel after sending
                const panel = document.getElementById(`emojiPanel-${roomId}`);
                const wrapper = input.closest('.input-wrapper');
                if (panel) panel.hidden = true;
                if (wrapper) wrapper.classList.remove('show-emoji');
            }
        }

        function updateActiveRooms() {
            activeRooms = Object.keys(chatWindows).length;
            activeRoomsSpan.textContent = `Active Rooms: ${activeRooms}`;
        }


  // Add once in admin.html
  function insertAtCursor(textarea, text) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const value = textarea.value;
    textarea.value = value.slice(0, start) + text + value.slice(end);
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
    autoResize(textarea);
  }
  function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 160) + 'px';
  }

  function setupInputUI(roomId) {
    const textarea = document.getElementById(`input-${roomId}`);
    const toggle = document.getElementById(`emojiToggle-${roomId}`);
    const panel = document.getElementById(`emojiPanel-${roomId}`);
    const wrapper = textarea.closest('.input-wrapper');

    // Handle Enter key for sending messages
    const handleKey = (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(roomId);
        autoResize(textarea);
      }
    };

    // Auto-hide emoji panel on focus/typing
    textarea.addEventListener('focus', () => { 
      panel.hidden = true; 
      wrapper.classList.remove('show-emoji'); 
    });
    textarea.addEventListener('keydown', (e) => { 
      panel.hidden = true; 
      wrapper.classList.remove('show-emoji'); 
      handleKey(e);
    });

    // Auto-resize textarea
    textarea.addEventListener('input', () => autoResize(textarea));

    // Emoji toggle
    toggle.addEventListener('click', () => {
      const open = panel.hidden;
      panel.hidden = !open;
      wrapper.classList.toggle('show-emoji', !panel.hidden);
    });

    // Emoji selection
    panel.addEventListener('click', (e) => {
      if (e.target.classList.contains('emoji')) {
        insertAtCursor(textarea, e.target.textContent);
        textarea.focus();
      }
    });

    // Close emoji panel when clicking outside
    window.addEventListener('click', (e) => {
      if (!panel.contains(e.target) && e.target !== toggle) {
        panel.hidden = true;
        wrapper.classList.remove('show-emoji');
      }
    });
  }

  // Call this inside createChatWindow after adding to DOM:
  // setupInputUI(roomId);


        // Global function for button onclick
        window.sendMessage = sendMessage;
    </script>
</body>
</html> 